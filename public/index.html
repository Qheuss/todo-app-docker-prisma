<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-slate-900 text-slate-50">
    <div class="min-h-screen max-w-3xl mx-auto p-4 sm:p-8">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-semibold">Minimal Todo</h1>
          <p class="text-sm text-slate-300" id="headerSubtitle">
            Stay on top of tasks.
          </p>
        </div>
        <button
          id="logoutBtn"
          class="hidden text-sm text-amber-200 hover:text-amber-100"
          onclick="logout()"
        >
          Logout
        </button>
      </header>

      <section
        id="auth"
        class="bg-slate-800/80 border border-slate-700 rounded-xl p-6 shadow-lg space-y-4"
      >
        <div>
          <h2 id="authTitle" class="text-xl font-semibold">Login</h2>
          <p id="authSubtitle" class="text-slate-300 text-sm">
            Access your todos securely.
          </p>
        </div>

        <div class="space-y-3">
          <input
            id="emailInput"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm"
            placeholder="Email"
          />
          <input
            id="passwordInput"
            type="password"
            class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm"
            placeholder="Password"
          />
        </div>

        <p id="error" class="hidden text-sm text-red-300"></p>

        <div class="flex items-center gap-3">
          <button
            id="authBtn"
            onclick="authenticate()"
            class="flex-1 rounded-lg bg-blue-500 hover:bg-blue-400 text-white px-4 py-2 text-sm font-medium"
          >
            Submit
          </button>
          <button
            onclick="toggleIsRegister()"
            id="registerBtn"
            class="text-sm text-slate-300 hover:text-white"
          >
            Switch to Sign up
          </button>
        </div>
      </section>

      <section id="app" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-300">You have</p>
            <h2 id="openCount" class="text-2xl font-semibold">0 open tasks</h2>
          </div>
          <div
            class="inline-flex bg-slate-800/70 border border-slate-700 rounded-lg p-1 text-sm"
            id="tabs"
          >
            <button
              class="tab px-3 py-1 rounded-md bg-blue-500 text-white"
              data-tab="All"
              onclick="changeTab('All')"
            >
              All
            </button>
            <button
              class="tab px-3 py-1 rounded-md text-slate-200"
              data-tab="Open"
              onclick="changeTab('Open')"
            >
              Open
            </button>
            <button
              class="tab px-3 py-1 rounded-md text-slate-200"
              data-tab="Complete"
              onclick="changeTab('Complete')"
            >
              Complete
            </button>
          </div>
        </div>

        <div id="todoList" class="space-y-3"></div>

        <div
          class="bg-slate-800/70 border border-slate-700 rounded-xl p-3 flex items-center gap-3"
        >
          <input
            id="todoInput"
            class="flex-1 rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm"
            placeholder="Add a task"
          />
          <button
            onclick="addTodo()"
            class="rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-2 text-sm font-medium"
          >
            Add
          </button>
        </div>
      </section>
    </div>
  </body>

  <script>
    let token = localStorage.getItem('token');
    let isAuthenticating = false;
    let isRegistration = false;
    let selectedTab = 'All';
    let todos = [];

    const apiBase = '/';

    const authSection = document.getElementById('auth');
    const appSection = document.getElementById('app');
    const errorText = document.getElementById('error');
    const email = document.getElementById('emailInput');
    const password = document.getElementById('passwordInput');
    const authBtn = document.getElementById('authBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authTitle = document.getElementById('authTitle');
    const authSubtitle = document.getElementById('authSubtitle');
    const todoListEl = document.getElementById('todoList');
    const todoInput = document.getElementById('todoInput');
    const openCount = document.getElementById('openCount');
    const logoutBtn = document.getElementById('logoutBtn');
    const headerSubtitle = document.getElementById('headerSubtitle');

    function setAuthMode(reg) {
      isRegistration = reg;
      authTitle.textContent = reg ? 'Sign up' : 'Login';
      authSubtitle.textContent = reg
        ? 'Create your account.'
        : 'Access your todos.';
      registerBtn.textContent = reg ? 'Switch to Login' : 'Switch to Sign up';
    }

    function toggleIsRegister() {
      setAuthMode(!isRegistration);
    }

    function showError(msg) {
      errorText.textContent = msg || '';
      errorText.classList.toggle('hidden', !msg);
    }

    function setLoading(btn, loading, text) {
      btn.disabled = loading;
      btn.textContent = loading ? text : 'Submit';
      btn.classList.toggle('opacity-60', loading);
    }

    async function authenticate() {
      const emailVal = email.value.trim();
      const passVal = password.value;
      if (
        !emailVal ||
        !passVal ||
        passVal.length < 6 ||
        !emailVal.includes('@')
      )
        return;
      if (isAuthenticating) return;

      showError('');
      isAuthenticating = true;
      setLoading(authBtn, true, isRegistration ? 'Signing up…' : 'Signing in…');

      try {
        const response = await fetch(
          apiBase + `auth/${isRegistration ? 'register' : 'login'}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: emailVal, password: passVal }),
          }
        );
        const data = await response.json();
        if (!response.ok || !data.token)
          throw new Error(data.error || 'Authentication failed');

        token = data.token;
        localStorage.setItem('token', token);
        await fetchTodos();
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        headerSubtitle.textContent = emailVal;
      } catch (err) {
        showError(err.message);
      } finally {
        isAuthenticating = false;
        setLoading(authBtn, false);
      }
    }

    function logout() {
      token = null;
      localStorage.removeItem('token');
      appSection.classList.add('hidden');
      authSection.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      todos = [];
      renderTodos();
    }

    async function fetchTodos() {
      if (!token) return;
      const res = await fetch(apiBase + 'todos', {
        headers: { Authorization: token },
      });
      if (!res.ok) throw new Error('Failed to load todos');
      todos = await res.json();
      renderTodos();
    }

    async function addTodo() {
      const task = todoInput.value.trim();
      if (!task || !token) return;
      const res = await fetch(apiBase + 'todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: token },
        body: JSON.stringify({ task }),
      });
      if (!res.ok) return alert('Failed to add');
      todoInput.value = '';
      await fetchTodos();
    }

    async function updateTodo(id) {
      if (!token) return;
      const res = await fetch(apiBase + 'todos/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: token },
        body: JSON.stringify({ completed: true }),
      });
      if (!res.ok) return alert('Failed to update');
      await fetchTodos();
    }

    async function deleteTodo(id) {
      if (!token) return;
      const res = await fetch(apiBase + 'todos/' + id, {
        method: 'DELETE',
        headers: { Authorization: token },
      });
      if (!res.ok) return alert('Failed to delete');
      await fetchTodos();
    }

    function changeTab(tab) {
      selectedTab = tab;
      document.querySelectorAll('.tab').forEach((btn) => {
        const active = btn.dataset.tab === tab;
        btn.className = `tab px-3 py-1 rounded-md text-sm ${
          active ? 'bg-blue-500 text-white' : 'text-slate-200'
        }`;
      });
      renderTodos();
    }

    function renderTodos() {
      const filtered = todos.filter((t) =>
        selectedTab === 'All'
          ? true
          : selectedTab === 'Complete'
          ? t.completed
          : !t.completed
      );
      const open = todos.filter((t) => !t.completed).length;
      openCount.textContent = `${open} open task${open === 1 ? '' : 's'}`;

      todoListEl.innerHTML = filtered
        .map(
          (t) => `
            <div class="flex items-center justify-between bg-slate-800/70 border border-slate-700 rounded-xl p-3">
              <div>
                <p class="font-medium ${
                  t.completed ? 'line-through text-slate-400' : ''
                }">${t.task}</p>
                <p class="text-xs text-slate-400">ID: ${t.id}</p>
              </div>
              <div class="flex gap-2">
                <button class="px-3 py-1 rounded-lg text-xs bg-emerald-500 text-white disabled:opacity-40" ${
                  t.completed ? 'disabled' : ''
                } onclick="updateTodo(${t.id})">Done</button>
                <button class="px-3 py-1 rounded-lg text-xs bg-red-500 text-white" onclick="deleteTodo(${
                  t.id
                })">Delete</button>
              </div>
            </div>
          `
        )
        .join('');
    }

    // Auto-login if token exists
    if (token) {
      fetchTodos()
        .then(() => {
          authSection.classList.add('hidden');
          appSection.classList.remove('hidden');
          logoutBtn.classList.remove('hidden');
        })
        .catch(() => logout());
    }
  </script>
</html>
